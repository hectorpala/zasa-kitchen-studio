// Consolidated JavaScript for Zasa Kitchen Studio - v4.0 (Performance Optimized)
// Navigation + Lazy Loading + Analytics with Long Task Splitting
(function(){"use strict";const BREAKPOINTS={mobile:480,tablet:768,desktop:1200};let webpSupport=false;

// Utility for splitting long tasks
function yieldToMain(){return new Promise(resolve=>setTimeout(resolve,0));}
function scheduleWork(tasks){return new Promise(async resolve=>{for(const task of tasks){await task();if(tasks.length>1)await yieldToMain();}resolve();});}

// WebP support detection with yield
async function supportsWebP(){return new Promise(resolve=>{const webP=new Image();webP.onload=webP.onerror=()=>resolve(webP.height===2);webP.src="data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA";});}

function getDeviceType(){const w=window.innerWidth;return w<=BREAKPOINTS.mobile?"mobile":w<=BREAKPOINTS.tablet?"tablet":"desktop";}

// Navigation with chunked processing
function initNavigation(){const hamburger=document.getElementById("hamburger"),navList=document.getElementById("mainNav");if(hamburger&&navList){hamburger.addEventListener("click",()=>{requestAnimationFrame(()=>{hamburger.classList.toggle("active");navList.classList.toggle("active");document.body.style.overflow=navList.classList.contains("active")?"hidden":"auto";});});navList.querySelectorAll(".nav-link").forEach(link=>{link.addEventListener("click",()=>requestAnimationFrame(()=>{hamburger.classList.remove("active");navList.classList.remove("active");document.body.style.overflow="auto";}));});}}

// Scroll handler with aggressive throttling
let scrollTicking=false;function initScrollNavbar(){const navbar=document.querySelector(".navbar");const updateNavbar=()=>{navbar&&navbar.classList.toggle("scrolled",window.scrollY>100);scrollTicking=false;};window.addEventListener("scroll",()=>{if(!scrollTicking){requestAnimationFrame(updateNavbar);scrollTicking=true;}},{passive:true});}

// Optimized image loading with chunking
function createPictureElement(img){return new Promise(resolve=>{const picture=document.createElement("picture");const webpSource=document.createElement("source");const jpgSource=document.createElement("source");const fallbackImg=img.cloneNode(true);const srcPath=img.dataset.src||img.src;const webpPath=srcPath.replace(/\.(jpg|jpeg|png)$/i,".webp");if(webpSupport){webpSource.srcset=webpPath;webpSource.type="image/webp";}jpgSource.srcset=srcPath;jpgSource.type="image/jpeg";if(img.dataset.srcset){const webpSrcset=img.dataset.srcset.replace(/\.(jpg|jpeg|png)/gi,".webp");webpSource.srcset=webpSrcset;jpgSource.srcset=img.dataset.srcset;}fallbackImg.src=srcPath;fallbackImg.removeAttribute("data-src");fallbackImg.removeAttribute("data-srcset");fallbackImg.classList.add("lazyloaded");picture.appendChild(webpSource);picture.appendChild(jpgSource);picture.appendChild(fallbackImg);resolve(picture);});}

async function loadImage(img){if(img.classList.contains("lazyloaded"))return;const srcPath=img.dataset.src||img.src;if(srcPath.match(/\.(jpg|jpeg|png)$/i)&&webpSupport){const picture=await createPictureElement(img);img.parentNode.replaceChild(picture,img);return;}img.src=img.dataset.src||img.src;if(img.dataset.srcset){img.srcset=img.dataset.srcset;img.removeAttribute("data-srcset");}img.removeAttribute("data-src");img.classList.add("lazyloaded");img.addEventListener("load",()=>img.style.opacity="1");}

// Chunked lazy loading with better performance
async function initResponsiveLazyLoading(){const observer=new IntersectionObserver(async(entries,obs)=>{const tasks=entries.filter(entry=>entry.isIntersecting).map(entry=>async()=>{const target=entry.target;if(target.tagName==="PICTURE"){const img=target.querySelector("img");const sources=target.querySelectorAll("source[data-srcset]");sources.forEach(source=>{if(source.dataset.srcset){source.srcset=source.dataset.srcset;source.removeAttribute("data-srcset");}});if(img&&img.dataset.src){img.src=img.dataset.src;img.removeAttribute("data-src");}if(img&&img.dataset.srcset){img.srcset=img.dataset.srcset;img.removeAttribute("data-srcset");}img.classList.add("lazyloaded");img.style.opacity="1";}else{await loadImage(target);}obs.unobserve(target);});await scheduleWork(tasks);},{rootMargin:"50px 0px",threshold:0.01});const images=document.querySelectorAll("img[data-src],img[loading='lazy'],picture");images.forEach(element=>{const img=element.tagName==="PICTURE"?element.querySelector("img"):element;if(img){img.style.opacity="0";img.style.transition="opacity 0.3s ease";observer.observe(element);}});}

// Deferred critical image preload
function preloadCriticalImages(){requestIdleCallback(()=>{const hero=document.querySelector(".hero");const criticalPictures=document.querySelectorAll(".service-card:nth-child(-n+3) picture, .hero picture");[hero,...criticalPictures].forEach(element=>{if(element){const img=element.querySelector?element.querySelector("img"):null;if(img&&img.dataset.src){const deviceType=getDeviceType();let srcToPreload=img.dataset.src;if(element.querySelector&&element.querySelector("source")){const appropriateSource=element.querySelector(`source[media*="${BREAKPOINTS[deviceType]}"]`);if(appropriateSource&&appropriateSource.dataset.srcset){srcToPreload=appropriateSource.dataset.srcset.split(" ")[0];}}const link=document.createElement("link");link.rel="preload";link.as="image";link.href=srcToPreload;link.fetchPriority="high";document.head.appendChild(link);}}})||setTimeout(preloadCriticalImages,16);});} // Fallback for browsers without requestIdleCallback

// Deferred analytics initialization
function initAnalytics(){setTimeout(()=>{document.querySelectorAll('a[href^="tel:"]').forEach(link=>{link.addEventListener("click",function(){typeof gtag!=="undefined"&&gtag("event","phone_call_click",{event_category:"engagement",event_label:this.dataset.phone||"header"});});});document.querySelectorAll('a[href*="wa.me"]').forEach(link=>{link.addEventListener("click",function(){typeof gtag!=="undefined"&&gtag("event","whatsapp_click",{event_category:"engagement",event_label:"whatsapp"});});});},100);}

// Optimized resize handler with debouncing
let resizeTimeout;function updatePictureSourcesOnResize(){clearTimeout(resizeTimeout);resizeTimeout=setTimeout(()=>{const pictures=document.querySelectorAll("picture");pictures.forEach(picture=>{const img=picture.querySelector("img");if(img&&!img.classList.contains("lazyloaded"))return;const deviceType=getDeviceType();const sources=picture.querySelectorAll("source");sources.forEach(source=>{const media=source.getAttribute("media");if(media){const shouldLoad=media.includes("max-width: 480px")&&deviceType==="mobile"||media.includes("max-width: 768px")&&deviceType==="tablet"||!media.includes("max-width")&&deviceType==="desktop";if(shouldLoad&&!source.hasAttribute("data-loaded")){source.setAttribute("data-loaded","true");}}});});},150);}

window.addEventListener("resize",updatePictureSourcesOnResize,{passive:true});if("PerformanceObserver"in window){const perfObserver=new PerformanceObserver(list=>{list.getEntries().forEach(entry=>{if(entry.entryType==="largest-contentful-paint"){console.log(`LCP: ${entry.startTime}ms`);}});});perfObserver.observe({entryTypes:["largest-contentful-paint"]});}const style=document.createElement("style");style.textContent=`img[data-src]{opacity:0;transition:opacity 0.3s ease}.lazyloaded{opacity:1 !important}picture{display:inline-block}picture img{display:block;width:100%;height:auto}`;document.head.appendChild(style);

// Enhanced DOMContentLoaded with task scheduling
document.addEventListener("DOMContentLoaded",async function(){const criticalTasks=[()=>supportsWebP().then(supported=>webpSupport=supported),()=>initNavigation(),()=>initScrollNavbar()];const deferredTasks=[()=>preloadCriticalImages(),()=>initResponsiveLazyLoading(),()=>initAnalytics(),()=>updatePictureSourcesOnResize(),()=>document.body.classList.add("fonts-loaded")];await scheduleWork(criticalTasks);(requestIdleCallback||setTimeout)(()=>scheduleWork(deferredTasks),0);});

})();